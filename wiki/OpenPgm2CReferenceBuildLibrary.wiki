#summary OpenPGM 2 : C Reference : Build Library
#labels Phase-Implementation
#sidebar TOC2CReference
=== Introduction ===
There are currently no official releases or pre-built packages in any distributions.  The OpenPGM library must be built from source taken from the projects subversion repository.

=== Building in openSUSE 11.1 ===
First install the C compiler dependencies and the SCons build tool.
<pre>
 $ sudo zypper install gcc scons
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.
<pre>
 $ sudo zypper install libsoup-devel net-snmp-devel
</pre>
To download the source code Subversion is needed to contact the repository.
<pre>
 $ sudo zypper install subversion
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build without the ncurses examples as <tt>libpanel</tt> is not included.
<pre>
 $ cd trunk/openpgm/pgm
 $ scons WITH_NCURSES=false
</pre>
By default SCons is configured to build the debug tree in <tt>./ref/debug</tt> to build the release version in <tt>./ref/release</tt>.
<pre>
 $ scons BUILD=release WITH_NCURSES=false
</pre>

=== Building in !OpenSolaris 2008.11 or 2009.06 under SCons ===
First install all the C compiler dependencies and Subversion.  Install the library dependencies, primarily GLib.
<pre>
 SUNWsvn SUNWgcc SUNWgnome-common-devel SUNWgnome-base-libs SUNWlibsoup (IPSnetsnmp)
</pre>
Download and build stable release of SCons.
<pre>
 $ wget http://nchc.dl.sourceforge.net/sourceforge/scons/scons-1.2.0.tar.gz 
 $ tar zxf scons-1.2.0.tar.gz
 $ cd scons-1.2.0
 $ sudo python setup.py install
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build.
<pre>
 $ cd trunk/openpgm/pgm
 $ scons -f SConstruct.Solaris
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.Solaris
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons -f SConstruct.Solaris BUILD=release
</pre>

=== Cross-compiling in Ubuntu 9.04 through 10.04 for Win32 under SCons and MinGW ===
First install all the C compiler dependencies, SCons, and Subversion.
<pre>
 $ sudo apt-get install build-essential scons subversion mingw32
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk 
 $ cd trunk/openpgm/pgm 
</pre>
Download and unpack the Win32 library dependencies, primarily GLib Binaries & Dev, and proxy-libintl Binaries.  Extract into a subdirectory called <tt>win/</tt>.

  * http://www.gtk.org/download-windows.html
<pre>
 $ cd win 
 $ wget http://ftp.gnome.org/pub/gnome/binaries/win32/glib/2.20/glib_2.20.4-1_win32.zip \
        http://ftp.gnome.org/pub/gnome/binaries/win32/glib/2.20/glib-dev_2.20.4-1_win32.zip \
        http://ftp.gnome.org/pub/gnome/binaries/win32/dependencies/proxy-libintl-dev_20080918_win32.zip 
 $ for i in `*`.zip; do unzip $i; done
</pre>
Update the <tt>pkgconfig</tt> configuration for where the root directory is located.
<pre>
 $ for i in lib/pkgconfig/`*`.pc; do sed -i "s#prefix=c:/.`*`#prefix=``pwd``#" $i; done
</pre>
Patch the mingw32 installation with updated Win32 headers.  For Ubuntu 9.04 or 9.10 use the 3.13 runtime patch,
<pre>
 $ sudo patch -d /usr/i586-mingw32msvc/include < mingw32-runtime_3.13-1openpgm3.diff
</pre>
For Ubuntu 10.04 use the 3.15 runtime patch,
<pre>
 $ sudo patch -d /usr/i586-mingw32msvc/include < mingw32-runtime_3.15.2-0openpgm1.diff
</pre>
Build.
<pre>
 $ cd ..
 $ scons -f SConstruct.mingw
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.mingw
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons -f SConstruct.mingw BUILD=release
</pre>

=== Cross-compiling in Ubuntu 8.04 for Win64 under SCons and MinGW-w64 ===
First install all the C compiler dependencies, SCons, and Subversion.
<pre>
 $ sudo apt-get install build-essential scons subversion
</pre>
Download and unpack [http://sourceforge.net/projects/mingw-w64/files/ MinGW-w64].
<pre>
 $ wget http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Release%20for%20GCC%204.4.1/mingw-w64-bin_x86-64-linux_4.4.1-1a.tar.bz2/download 
 $ sudo mkdir /opt/mingw 
 $ sudo tar xjf -C /opt/mingw mingw-w64-`*`
</pre>
Setup an environment for MinGW.
<pre>
 $ cat - | sudo tee mingwvars.sh
#!/bin/sh
if `[` -z "${PATH}" `]`
then
    PATH="/opt/mingw/bin"; export PATH
else
    PATH="/opt/mingw/bin:${PATH}"; export PATH
fi
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk 
 $ cd trunk/openpgm/pgm
</pre>
Download and unpack the Win64 library dependencies, primarily GLib Binaries & Dev, and proxy-libintl Binaries.  Extract into a subdirectory called <tt>win/</tt>.

  * http://ftp.gnome.org/pub/GNOME/binaries/win64/
<pre>
 $ cd win64
 $ wget http://ftp.gnome.org/pub/GNOME/binaries/win64/glib/2.20/glib_2.20.1-1_win64.zip  \
        http://ftp.gnome.org/pub/GNOME/binaries/win64/glib/2.20/glib-dev_2.20.1-1_win64.zip  \
        http://ftp.gnome.org/pub/GNOME/binaries/win64/dependencies/proxy-libintl-dev_20080918_win64.zip 
 $ for i in `*`.zip; do unzip $i; done
</pre>
Update the <tt>pkgconfig</tt> configuration for where the root directory is located.
<pre>
 $ for i in lib/pkgconfig/`*`.pc; do sed -i "s#prefix=c:/.`*`#prefix=``pwd``#" $i; done
</pre>
Patch the mingw-w64 installation with updated Windows headers.
<pre>
 $ sudo patch -d /opt/mingw/x86_64-w64-mingw32/include < mingw-w64-bin_x86-64-linux_4.4.1-1openpgm1.diff
</pre>
Build.
<pre>
 $ cd .. 
 $ source /opt/mingw/mingwvars.sh 
 $ scons -f SConstruct.097.mingw64
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.097.mingw64
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons -f SConstruct.097.mingw64 BUILD=release
</pre>

=== Building in Ubuntu 9.04 through 10.04 under SCons ===
First install all the C compiler dependencies, SCons, and Subversion.
<pre>
 $ sudo apt-get install build-essential scons subversion
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.  libncurses is only required for some examples.  Note that the repository contains multiple versions of libsoup with incompatible API.
<pre>
 $ sudo apt-get install libglib2.0-dev libsoup2.4-dev libncurses5-dev libsnmp-dev
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build.
<pre>
 $ cd trunk/openpgm/pgm
 $ scons
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons BUILD=release
</pre>

=== Building in Ubuntu 8.04 or 8.10 under SCons ===
First install all the C compiler dependencies, SCons, and Subversion.
<pre>
 $ sudo apt-get install build-essential scons subversion
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.  libncurses is only required for some examples.  Note that the repository contains multiple versions of libsoup with incompatible API.
<pre>
 $ sudo apt-get install libglib2.0-dev libsoup2.2-dev libncurses5-dev libsnmp-dev
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build.
<pre>
 $ cd trunk/openpgm/pgm
 $ scons
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.097
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons -f SConstruct.097 BUILD=release
</pre>

=== Building in Ubuntu 8.04 or 8.10 under SCons with Intel C++ Compiler 11.1 ===
First install all the C compiler dependencies, SCons, and Subversion.
<pre>
 $ sudo apt-get install build-essential scons subversion
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.  libncurses is only required for some examples.  Note that the repository contains multiple versions of libsoup with incompatible API.
<pre>
 $ sudo apt-get install libglib2.0-dev libsoup2.2-dev libncurses5-dev libsnmp-dev
</pre>
Install the Intel Compiler Suite following provided instructions.
<pre>
 $ tar zxf l_cproc_p_11.1.064_intel64.tgz
 $ cd l_cproc_p_11.1.064_intel64
 $ sudo ./install.sh
</pre>
Patch Scons to support version 11 of the compiler.
<pre>
 $ cd /usr/lib/scons/SCons/Tool
 $ sudo patch <
--- /usr/lib/scons/SCons/Tool/intelc.py	2007-12-04 04:20:54.000000000 +0800
+++ /tmp/intelc.py	2010-01-21 13:50:46.000000000 +0800
@@ -210,6 +210,10 @@
             # Typical dir here is /opt/intel/cc/9.0 for IA32,
             # /opt/intel/cce/9.0 for EMT64 (AMD64)
             versions.append(re.search(r'(`[`0-9.`]`+)$', d).group(1))
+        for d in glob.glob('/opt/intel/Compiler/`*`'):
+            # Typical dir here is /opt/intel/cc/9.0 for IA32,
+            # /opt/intel/cce/9.0 for EMT64 (AMD64)
+            versions.append(re.search(r'(`[`0-9.`]`+)$', d).group(1))
     versions = uniquify(versions)       # remove dups
     versions.sort(vercmp)
     return versions
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build.
<pre>
 $ cd trunk/openpgm/pgm 
 $ source /opt/intel/Compiler/11.1/064/bin/iccvars.sh 
 $ scons -f SConstruct.097.intelc
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.097.intelc
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons -f SConstruct.097.intelc BUILD=release
</pre>

=== Building in Debian 4.0 under SCons ===
Requires new installation of SCons as repository only contains version 0.96 which does not support <tt>autoconf</tt>.

First install all the C compiler dependencies and Subversion.
<pre>
 $ sudo apt-get install build-essential subversion
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.  libncurses is only required for some examples.  Note that the repository contains multiple versions of libsoup with incompatible API.
<pre>
 $ sudo apt-get install libglib2.0-dev libsoup2.4-dev libncurses5-dev libsnmp-dev
</pre>
Install dependencies to build a Debian package.
<pre>
 # sudo apt-get install fakeroot dpkg-dev
</pre>
Pull in the 1.0.0 SCons source from Lenny.
<pre>
 $ wget http://ftp.de.debian.org/debian/pool/main/s/scons/scons_1.0.0-1.dsc 
 $ wget http://ftp.de.debian.org/debian/pool/main/s/scons/scons_1.0.0.orig.tar.gz 
 $ wget http://ftp.de.debian.org/debian/pool/main/s/scons/scons_1.0.0-1.diff.gz 
 $ dpkg-source -x scons_1.0.0-1.dsc
 $ cd scons-1.0.0/
 $ sudo apt-get build-dep scons
 $ dpkg-buildpackage -rfakeroot -b
</pre>
Install the new package.
<pre>
 $ sudo dpkg -i ../scons_1.0.0-1_all.deb
 $ cd ..
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build.
<pre>
 $ cd trunk/openpgm/pgm
 $ scons -f SConstruct.Debian4
</pre>
By default SCons is configured to build a debug tree in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.Debian4
</pre>
To build the release version in <tt>./ref/release</tt> use the following:
<pre>
 $ scons -f SConstruct.Debian4 BUILD=release
</pre>

=== Building in RHEL or CentOS 4.x ===
Don't, for the following reasons.

==== Issues ====
  # <tt>pkg-config</tt> does not support <tt>--static</tt> to provide static library parameters for GLib and other packages.
  # <tt>libsoup-devel-2.2.1-4.i386.rpm</tt> is broken.
  # Old <tt>gcc</tt> does not support new warnings, <tt>-Wunsafe-loop-optimizations</tt>.
  # GLib 2.10 is required for the [http://library.gnome.org/devel/glib/stable/glib-Memory-Slices.html SLAB allocator], the default packaged version is 2.4.  A special 2.12 build is available as a dependency for Evolution, <tt>evolution28-glib2-devel.i386</tt>.
  # <tt>libsoup</tt> 2.2.1 does not support asynchronous callbacks, however the <tt>evolution28-libsoup-devel.i386</tt> does.
  # <tt>evolution28-libsoup-devel.i386</tt> has an extra hidden dependency on <tt>gobject</tt>.


==== Rebuilding yum packages ====
Setup user packaging as per [http://wiki.centos.org/TipsAndTricks/YumAndRPM YumAndRPM] in the CentOS wiki.  Download the source package from Red Hat or CentOS, then rebuild the package, installing any additional build dependencies as necessary.
<pre>
 $ wget http://mirror.centos.org/centos/4/os/SRPMS/libsoup-2.2.1-4.src.rpm 
 $ sudo yum install gnutls-devel
 $ rpmbuild --rebuild libsoup-`*`.src.rpm 
 $ sudo rpm -i redat/RPMS/libsoup-devel-`*`.rpm
</pre>

==== Building ====
First install the C compiler dependencies.
<pre>
 $ sudo yum install gcc
</pre>
Install SCons by downloading the [http://scons.org/download.php 0.97 stable package].
<pre>
 $ sudo rpm -i scons-0.97-1.noarch.rpm
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.  libncurses is only required for some examples.  Note we are install the Evolution 2.8 versions of the GLib suite, not the default packages.
<pre>
 $ sudo yum install evolution28-glib2-devel evolution28-libsoup-devel ncurses-devel net-snmp-devel
</pre>
Red Hat net-snmp libraries are a bit chunky and need some extras:
<pre>
 $ sudo yum install lm_sensors-devel
</pre>
To download the source code Subversion is needed to contact the repository.
<pre>
 $ sudo yum install subversion
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
For the default debug build use the following and look in <tt>./ref/debug</tt>:
<pre>
 $ scons -f SConstruct.RHEL4
</pre>

==== Testing ====
The lack of static library support in <tt>pkg-config</tt> requires extra steps for testing, Red Hat <tt>sudo</tt> by default blocks <tt>LD_LIBRARY_PATH</tt> exports.
<pre>
 $ sudo bash
 $ LD_LIBRARY_PATH=/usr/evolution28/lib ./pgmrecv
</pre>

== Building in RHEL or CentOS 5.1-5.3 ==
First install the C compiler dependencies.
<pre>
 $ sudo yum install gcc
</pre>
Install SCons by downloading the [http://scons.org/download.php 0.97 stable package].
<pre>
 $ sudo rpm -i scons-0.97-1.noarch.rpm
</pre>
Install the library dependencies, primarily GLib, libsoup, and net-snmp libraries.  libncurses is only required for some examples.
<pre>
 $ sudo yum install glib2-devel libsoup-devel ncurses-devel net-snmp-devel
</pre>
Red Hat net-snmp libraries are a bit chunky and need some extras:
<pre>
 $ sudo yum install lm_sensors-devel
</pre>
To download the source code Subversion is needed to contact the repository.
<pre>
 $ sudo yum install subversion
</pre>
Checkout the repository as per the [http://code.google.com/p/openpgm/source/checkout Subversion guide].
<pre>
 $ svn checkout http://openpgm.googlecode.com/svn/trunk
</pre>
Build.
<pre>
 $ cd trunk/openpgm/pgm
 $ scons -f SConstruct.097
</pre>
By default SCons is configured to build the debug tree in <tt>./ref/debug</tt> to build the release version in <tt>./ref/release</tt>.
<pre>
 $ scons -f SConstruct.097 BUILD=release
</pre>

=== PGM Testing ===
Two hosts are required for full PGM protocol testing, one to send the other to receive.  In this example <tt>ayaka</tt> is the sending host and <tt>kiku</tt> is receiving.

On the receiving host run the OpenPGM receiver.
<pre>
 kiku$ sudo ./ref/debug/examples/pgmrecv 
 `*``*` Message: pgmrecv
 2008-05-27 18:02:53 kiku: scheduling startup.
 2008-05-27 18:02:53 kiku: entering main event loop ... 
 2008-05-27 18:02:53 kiku: startup.
 2008-05-27 18:02:53 kiku: create transport.
 2008-05-27 18:02:53 kiku: startup complete.
</pre>
On the sending host run the OpenPGM publisher.
<pre>
 ayaka$ sudo ./ref/debug/examples/pgmsend mooooo baa
</pre>
Then on the receiver you should see the test messages.
<pre>
 2008-05-27 18:03:25 kiku: (7 bytes)
 2008-05-27 18:03:25 kiku: 	1: "mooooo" (7 bytes)
 2008-05-27 18:03:25 kiku: (4 bytes)
 2008-05-27 18:03:25 kiku: 	1: "baa" (4 bytes)
</pre>
Without explicit network parameter passing OpenPGM will assume the default adapter and either IPv4 or IPv6 addressing.  If your operating system defaults to DHCP it is possible that the nodename of the host resolves to localhost and not a real adapter, it is then necessary to explicitly set the adapter name.  Similarly you might have problems with IPv6 auto-configuration and multiple scopes per adapter.  So on a default !OpenSolaris install you might wish to try the following:
<pre>
 opensolaris$ sudo ./ref/debug/examples/pgmsend -n "pcn0;239.192.0.1" ichigo milk 
</pre>

=== PGM Testing on Multicast Loopback ===

For multicast loopback testing using only one host requires use of a low-resolution timing mechanism as the <tt>/dev/rtc</tt> real-time clock device cannot be shared.  The example <tt>pgmrecv</tt> and <tt>pgmsend</tt> applications have convenience parameters to automagically enable this configuration.  For this demonstration we will also use UDP encapsulation of the PGM protocol so as not to require any extra system privileges.  On one terminal start a receiver.
<pre>
 aiko$ ./ref/debug/examples/pgmrecv -lp 3065
 `*``*` Message: pgmrecv
 2008-11-19 17:59:05 aiko: setting low resolution timers for multicast loopback.
 2008-11-19 17:59:05 aiko: scheduling startup.
 2008-11-19 17:59:05 aiko: entering main event loop ... 
 2008-11-19 17:59:05 aiko: startup.
 2008-11-19 17:59:05 aiko: create transport.
 2008-11-19 17:59:05 aiko: startup complete.
</pre>
In another terminal send some test messages:
<pre>
 $ ./ref/debug/examples/pgmsend -lp 3065 mooo baa
 2008-11-19 17:59:18 aiko: setting low resolution timers for multicast loopback.
</pre>
In the receiving terminal you should see the correct receipt of two messages.
<pre>
 2008-11-19 17:59:18 aiko: (5 bytes)
 2008-11-19 17:59:18 aiko: 	1: "mooo" (5 bytes)
 2008-11-19 17:59:18 aiko: (4 bytes)
 2008-11-19 17:59:18 aiko: 	1: "baa" (4 bytes)
</pre>